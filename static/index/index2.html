<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
  <script src="http://7o50ww.com1.z0.glb.clouddn.com/three.js"></script>
  <script src="http://7o50ww.com1.z0.glb.clouddn.com/DDSLoader.js"></script>
  <script src="http://7o50ww.com1.z0.glb.clouddn.com/MTLLoader.js"></script>
  <script src="http://7o50ww.com1.z0.glb.clouddn.com/OBJLoader.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/16.6.0/Tween.min.js"></script>
  <script src="../satellite/ColladaLoader.js"></script>
  <script src="../satellite/trackball.js"></script>
  <script src="../js/shaders.js"></script>

</head>
<style>
  body {
    font-family: Monospace;
    /*background-color: #000;*/
    color: #fff;
    margin: 0px;
    overflow: hidden;
  }

  html {
    height: 100%;
    width: 100%;
  }

  #container {
    width: 100vh;
    height:100vw;
  }

</style>
<body>

<div id="container"></div>

<script>

  console.log(TWEEN);
  var Shaders = {
    'earth' : {
      uniforms: {
        'texture': { type: 't', value: null }
      },
      vertexShader: [
        'varying vec3 vNormal;',
        'varying vec2 vUv;',
        'void main() {',
        'gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );',
        'vNormal = normalize( normalMatrix * normal );',
        'vUv = uv;',
        '}'
      ].join('\n'),
      fragmentShader: [
        'uniform sampler2D texture;',
        'varying vec3 vNormal;',
        'varying vec2 vUv;',
        'void main() {',
        'vec3 diffuse = texture2D( texture, vUv ).xyz;',
        'float intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );',
        'vec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );',
        'gl_FragColor = vec4( diffuse + atmosphere, 1.0 );',
        '}'
      ].join('\n')
    },
    'atmosphere' : {
      uniforms: {},
      vertexShader: [
        'varying vec3 vNormal;',
        'void main() {',
        'vNormal = normalize( normalMatrix * normal );',
        'gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );',
        '}'
      ].join('\n'),
      fragmentShader: [
        'varying vec3 vNormal;',
        'void main() {',
        'float intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );',
        'gl_FragColor = vec4( 1.0, 1.0, 1.0, 1.0 ) * intensity;',
        '}'
      ].join('\n')
    },

  };


  var _self = {
    container:null,
    camera:null,
    scene:null,
    renderer:null,
    satellite:null,
    earth:null,
    laser:null,
    //激光
    controls:null,
    timer:0,
    vector:null,
    sateGroup:null
  }


  var flag = {

  }

  var text1 = "(ಡωಡ)"
  var tex2 = ""

  var Timer = {
      timer1:0,
    timer2:0,
    timer3:0
  }

  var Tween={
      satTween:null,
      lasTween1:null,
      lasTween2:null,
      lasTween3:null,
      lasTween4:null,
    camTween1:null,
    camTween2:null,
    earthTween1:null,
    camLookat:null,
    spotLight:null
  }

  var Camchange = {
  }


  var rotateSpeed = 0.015;









  // todo 创建scene
  _self.container = document.getElementById("container");
  //todo 相机
  _self.camera = new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,10000);
  _self.camera.position.x = 0;
  _self.camera.position.y = 0;
  _self.camera.position.z = 1700;
  _self.camera.rotateY(Math.PI);

  //scene
  _self.scene = new THREE.Scene();
//  _self.scene.fog = new THREE.FogExp2( 0x000000, 0.1 );


  // 添加 控件调节
  _self.controls = new THREE.TrackballControls(_self.camera);
  _self.controls.rotateSpeed = 1.0;
  _self.controls.zoomSpeed = 1.0;
  _self.controls.panSpeed = 1.0;
  var Clock = new  THREE.Clock();

  var axis = new THREE.AxisHelper(5000);

  _self.scene.add(axis);


  // todo 创建环境光
  var surLight = new THREE.AmbientLight(0xffffff);
  _self.scene.add(surLight);





  // 创建renderer
  _self.renderer=new THREE.WebGLRenderer();
  _self.renderer.setPixelRatio(window.devicePixelRatio);
  console.log(_self.renderer);

  _self.renderer.setSize(window.innerWidth,window.innerHeight);
  _self.container.appendChild(_self.renderer.domElement);


  // 创建定位点

  //todo 一些定位点
  _self.vector = new THREE.Vector3(0,0,0) ;
  _self.camera.lookAt(_self.vector);

  window.addEventListener("resize",resizeWindow);



  _self.sateGroup = new THREE.Group();

  //todo 创建字体
//  var Fongeo1 = new THREE.TextGeometry( text1, {
//
//    size: 80,
//    height: 20,
//    curveSegments: 2
//  });
//
//  Fongeo1.computeBoundingBox();
//
//  var centerOffset = -0.5 * ( Fongeo1.boundingBox.max.x - Fongeo1.boundingBox.min.x );
//
//  var Fonmat1 =new THREE.MeshBasicMaterial( { color: Math.random() * 0xffffff, overdraw: 0.5 } );
//
//  var FontMesh1= new THREE.Mesh( Fongeo1, Fonmat1 );
//
//  FontMesh1.position.set(100,100,100);














  var mesh;
//todo 加载卫星
  var loder2 = new THREE.ColladaLoader();
  loder2.load("../../static/model/satellite.dae",function (result) {
    _self.satellite= result.scene.children[0].children[0].clone();
    _self.satellite.scale.set(0.005,0.005,0.005);


    _self.satellite.position.set(2000,0,-1000);
//            _self.satellite.rotation.set(100,100,100);

      _self.scene.add(_self.satellite);
    console.log( _self.satellite.position.x);

    //TODO 卫星动画
    Tween.satTween =new TWEEN.Tween(_self.satellite.position).to({
      x:0,
      y:0,
      z:1450
    },3000);


    Tween.satTween2 = new TWEEN.Tween(_self.satellite.position).to({
      x:0,
      y:-130,
      z:0
    },4000).delay(2000).easing(TWEEN.Easing.Quintic.Out);

    //TODO 相机没有动画！！！



    Tween.satTween.start();
//    console.log(_self.laser);

    //TODO 拉长光柱
//    Tween.lasTween1 = new TWEEN.Tween(_self.laser.scale).to({
//            x:0.0001,
//            y:0.0001,
//            z:5
//    },2000);

    //TODO 拉大光柱
    Tween.lasTween2 = new TWEEN.Tween(_self.laser.scale).to({
      x:5,
      y:5,
      z:5
    },2000).easing(TWEEN.Easing.
      Quintic.Out).onUpdate(function () {
//      console.log("开始xy");

    });

    //TODO 增加光柱透明度
    Tween.lasTween3 = new TWEEN.Tween(_self.laser.material).to({
      opacity:0.3
    },2000).easing(TWEEN.Easing.
      Quintic.Out).onUpdate(function () {
//      console.log("透明度");
    });

    //TODO 变化光柱颜色

    Tween.lasTween4 = new TWEEN.Tween(_self.laser.material.color).to({
      r:0.31,
      g:0.80,
      b:0.77
    },3000).easing(TWEEN.Easing.
      Quintic.Out).onUpdate(function () {
//      console.log("透明度");
    });

    //光柱向前移动



    //TODO 卫星 光线向上
Tween.satTween4 = new TWEEN.Tween(_self.satellite.position).to({
  x:0,
  y:300,
  z:0
},4000).easing(TWEEN.Easing.
  Quintic.Out);


    Tween.lasTween5 = new TWEEN.Tween(_self.laser.position).to({
      x:0,
      y:295,
      z:0
    },4000).easing(TWEEN.Easing.
      Quintic.Out);

   Tween.earthTween1 = new TWEEN.Tween(_self.earth.position).to({
      x:0,
      y:-1100,
      z:0
    },4000).onComplete(function () {
      rotateSpeed=0.01
    }).easing(TWEEN.Easing.
     Quintic.Out);

//todo 灯光消失 开始

    Tween.satTween5 = new TWEEN.Tween(_self.satellite.position).to({
      x:1000,
      y:500,
      z:0
    },4000).easing(TWEEN.Easing.
      Quintic.Out);


    Tween.lasTween6 = new TWEEN.Tween(_self.laser.scale).to({
      x:0.001,
      y:0.001,
      z:0.001
    },1000).easing(TWEEN.Easing.
      Quintic.Out);

    Tween.earthTween2 = new TWEEN.Tween(_self.earth.position).to({
      x:0,
      y:0,
      z:0
    },6000).onComplete(function () {
      rotateSpeed=0.008
    }).easing(TWEEN.Easing.Back.Out);

























    //TODO 动画连缀区
//    Tween.satTween.chain(Tween.satTween2,Tween.earthTween1);
    Tween.satTween.chain(Tween.satTween2);
  Tween.satTween2.chain(Tween.lasTween2,Tween.lasTween3);
    Tween.lasTween2.chain(Tween.lasTween4);

    Tween.lasTween4.chain(Tween.lasTween5,Tween.satTween4, Tween.earthTween1);
    Tween.lasTween5.chain(Tween.lasTween6,Tween.earthTween2);
    Tween.lasTween6.chain(Tween.satTween5);

//  Tween.lasTween1.chain(Tween.lasTween2);
  });
























  //todo 创建激光

  var pivot = new THREE.Object3D();


  var laser = new THREE.CylinderGeometry(2,50,200,100,100,true);
//  var laser = new THREE.CylinderGeometry(2,1,0,100,100,true);
  laser.rotateX(-Math.PI/2);

  laser.applyMatrix( new THREE.Matrix4().makeTranslation( 0, 0, 100 ) );

  var material = new THREE.MeshPhongMaterial({map:new THREE.TextureLoader().load("../img/transparentTexture.png"),transparent:true,opacity:0.0001});
  _self.laser = new THREE.Mesh(laser, material);
  _self.laser.position.set(0,-135,0);


  _self.laser.scale.set(0.0001,0.0001,0.0001);

  _self.scene.add(_self.laser);


  //todo 创建缀光线

//  _self.spotLight = new THREE.SpotLight(0xDD0000,10,1000,Math.PI);
//  _self.spotLight.position.set(0,-135,0);
//
//  _self.scene.add(_self.spotLight);


  // todo 创建地球

  var geometry = new THREE.SphereGeometry(600,100,100);

//  var shader = Shaders['earth'];
//  var uniforms = THREE.UniformsUtils.clone(shader.uniforms);

//  uniforms['texture'].value = THREE.ImageUtils.loadTexture("../img/earth.jpg");
//
//
//
//  var EarthMaterial = new THREE.ShadecrMaterial({
//
//    uniforms: uniforms,
//    vertexShader: shader.vertexShader,
//    fragmentShader: shader.fragmentShader
//
//  });

  // TODO 不用着色器

  var mat = new THREE.MeshLambertMaterial({map:new THREE.TextureLoader().load("../img/earth.jpg")});





  _self.earth = new THREE.Mesh(geometry, mat);
  _self.earth.rotation.y = Math.PI;
  _self.earth.position.set(0,-1500,0);
  _self.scene.add( _self.earth);






  //TODO 添加瞄准

  var aimPlane1 = new THREE.Plane(340,340);
  var aimPlane2 = new THREE.Plane(340,340);
  var aimPlane1Mat = new THREE.MeshBasicMaterial({
    map:new THREE.TextureLoader().load("../img/aimAtbig.png")
  });

  var aimPlane2Mat = new THREE.MeshBasicMaterial({
    map:new THREE.TextureLoader().load("../img/aimAtsmall.png")
  });

//
//  var aimMesh1 = new THREE.Mesh(
//
//  )
















  animate();

  // 动画区



  function animate() {
    var delta = Clock.getDelta();
    _self.controls.update(delta);
    TWEEN.update();



    //TODO 地球旋转

    _self.earth.rotation.y +=rotateSpeed;


    requestAnimationFrame(animate);
    render();
  }

  //TODO 主要动画区域



  function render(){

    Timer.timer1++;


    //首先是卫星飞出来

    //TODO 动画区

    _self.satellite.rotation.y +=0.03;
//    _self.satellite.rotation.y +=0.03;







    _self.laser.lookAt(_self.earth.position);

    _self.renderer.render(_self.scene,_self.camera);
  }












  // 事件  resize

  function resizeWindow() {
    _self.camera.aspect = window.innerWidth/window.innerHeight;

//    _self.camera.position.set(controler.x,controler.y,controler.z);
    _self.camera.updateProjectionMatrix();

    _self.renderer.setSize(window.innerWidth,window.innerHeight);

  }









function destoryFuc(a) {
  a&&a();
  a=null;
}
</script>
</body>
</html>
